<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Bruges Trip Details | Bruges Guide</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="animations.css">
    <link rel="stylesheet" href="responsive.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --primary-color: #4CAF50;
            --primary-dark: #388E3C;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
        }

        .main-header {
            background-color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
            list-style: none;
        }

        .nav-links a {
            color: #333;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-links a:hover {
            color: var(--primary-color);
        }

        .tour-details-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-radius: 10px;
        }

        .tour-header {
            text-align: center;
            margin-bottom: 3rem;
            padding: 3rem 2rem;
            background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url('https://images.unsplash.com/photo-1555396273-367ea4eb4db5?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80');
            background-size: cover;
            background-position: center;
            color: white;
            border-radius: 10px;
        }

        .tour-header h1 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .tour-header p {
            font-size: 1.2rem;
            max-width: 800px;
            margin: 0 auto;
        }

        .tour-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .summary-card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
        }

        .summary-card i {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .summary-card h3 {
            margin-bottom: 0.5rem;
        }

        .summary-card .count {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .tour-sections {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        .tour-section {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .section-header {
            background: var(--primary-color);
            color: white;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .section-header i {
            font-size: 1.5rem;
        }

        .section-content {
            padding: 1.5rem;
        }

        .item-card {
            display: flex;
            align-items: flex-start;
            padding: 1.5rem;
            border-bottom: 1px solid #eee;
            gap: 1.5rem;
        }

        .item-card:last-child {
            border-bottom: none;
        }

        .item-image {
            width: 150px;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            flex-shrink: 0;
        }

        .item-details {
            flex: 1;
        }

        .item-details h3 {
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
            color: #333;
        }

        .item-details p {
            color: #666;
            margin-bottom: 0.5rem;
        }

        .item-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .action-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .action-btn:not(.secondary) {
            background: var(--primary-color);
            color: white;
        }

        .action-btn:not(.secondary):hover {
            background: var(--primary-dark);
        }

        .action-btn.secondary {
            background: #f0f0f0;
            color: #333;
        }

        .action-btn.secondary:hover {
            background: #e0e0e0;
        }

        .day-itinerary {
            margin-top: 2rem;
        }

        .day-header {
            background: #f0f0f0;
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
            font-weight: bold;
        }

        .timeline {
            position: relative;
            padding-left: 2rem;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--primary-color);
        }

        .timeline-item {
            position: relative;
            padding-bottom: 1.5rem;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -2.4rem;
            top: 0.5rem;
            width: 1rem;
            height: 1rem;
            border-radius: 50%;
            background: var(--primary-color);
        }

        .timeline-time {
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .timeline-content {
            background: white;
            padding: 1rem;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .map-container {
            height: 400px;
            width: 100%;
            border-radius: 10px;
            overflow: hidden;
            background: #f0f0f0;
        }

        .map-container .no-items {
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: #f5f5f5;
        }

        .no-items {
            text-align: center;
            padding: 3rem 2rem;
            color: #666;
        }

        .no-items i {
            font-size: 3rem;
            color: #ddd;
            margin-bottom: 1rem;
        }

        .print-btn {
            display: block;
            margin: 2rem auto;
            padding: 1rem 2rem;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .print-btn:hover {
            background: var(--primary-dark);
        }

        footer {
            background: white;
            padding: 2rem;
            margin-top: 3rem;
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
        }

        .footer-section h3 {
            color: var(--primary-color);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .footer-section ul {
            list-style: none;
        }

        .footer-section ul li {
            margin-bottom: 0.5rem;
        }

        .footer-section ul li a {
            color: #666;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .footer-section ul li a:hover {
            color: var(--primary-color);
        }

        .footer-bottom {
            text-align: center;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid #eee;
            color: #666;
        }

        @media (max-width: 768px) {
            .nav-links {
                display: none;
            }

            .tour-details-container {
                margin: 1rem;
                padding: 1rem;
            }

            .tour-header {
                padding: 2rem 1rem;
            }

            .tour-header h1 {
                font-size: 2rem;
            }

            .item-card {
                flex-direction: column;
            }

            .item-image {
                width: 100%;
                height: 200px;
            }

            .item-actions {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <header class="main-header">
        <nav>
            <div class="nav-container">
                <a href="index.html" class="logo">
                    <i class="fas fa-landmark"></i> Bruges Guide
                </a>
                <button class="mobile-menu-btn" aria-label="Toggle menu">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
            <ul class="nav-links">
                <li><a href="index.html"><i class="fas fa-home"></i> Home</a></li>
                <li><a href="places-to-visit.html"><i class="fas fa-map-marker-alt"></i> Places</a></li>
                <li><a href="restaurants.html"><i class="fas fa-utensils"></i> Food</a></li>
                <li><a href="tours.html"><i class="fas fa-ship"></i> Tours</a></li>
                <li><a href="gallery.html"><i class="fas fa-images"></i> Gallery</a></li>
                <li><a href="planner.html"><i class="fas fa-calendar-alt"></i> Plan</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <div class="tour-details-container">
            <div class="tour-header" data-aos="fade-down">
                <h1>Your Bruges Trip Details</h1>
                <p>Your personalized itinerary with all selected attractions, restaurants, tours, and photo spots</p>
            </div>

            <div class="tour-summary" data-aos="fade-up">
                <div class="summary-card">
                    <i class="fas fa-map-marker-alt"></i>
                    <h3>Places to Visit</h3>
                    <div class="count" id="places-count">0</div>
                </div>
                <div class="summary-card">
                    <i class="fas fa-utensils"></i>
                    <h3>Restaurants</h3>
                    <div class="count" id="restaurants-count">0</div>
                </div>
                <div class="summary-card">
                    <i class="fas fa-ship"></i>
                    <h3>Tours</h3>
                    <div class="count" id="tours-count">0</div>
                </div>
                <div class="summary-card">
                    <i class="fas fa-camera"></i>
                    <h3>Photo Spots</h3>
                    <div class="count" id="photos-count">0</div>
                </div>
            </div>

            <div class="tour-sections">
                <div class="tour-section" data-aos="fade-up">
                    <div class="section-header">
                        <i class="fas fa-map-marker-alt"></i>
                        <h2>Places to Visit</h2>
                    </div>
                    <div class="section-content" id="places-section">
                        <div class="no-items">
                            <i class="fas fa-map-marked-alt"></i>
                            <p>No places selected yet. Visit the Places page to add attractions to your trip.</p>
                        </div>
                    </div>
                </div>

                <div class="tour-section" data-aos="fade-up">
                    <div class="section-header">
                        <i class="fas fa-utensils"></i>
                        <h2>Restaurants</h2>
                    </div>
                    <div class="section-content" id="restaurants-section">
                        <div class="no-items">
                            <i class="fas fa-utensils"></i>
                            <p>No restaurants selected yet. Visit the Restaurants page to add dining options to your trip.</p>
                        </div>
                    </div>
                </div>

                <div class="tour-section" data-aos="fade-up">
                    <div class="section-header">
                        <i class="fas fa-ship"></i>
                        <h2>Tours</h2>
                    </div>
                    <div class="section-content" id="tours-section">
                        <div class="no-items">
                            <i class="fas fa-ship"></i>
                            <p>No tours selected yet. Visit the Tours page to add guided experiences to your trip.</p>
                        </div>
                    </div>
                </div>

                <div class="tour-section" data-aos="fade-up">
                    <div class="section-header">
                        <i class="fas fa-camera"></i>
                        <h2>Photo Spots</h2>
                    </div>
                    <div class="section-content" id="photos-section">
                        <div class="no-items">
                            <i class="fas fa-camera"></i>
                            <p>No photo spots selected yet. Visit the Photo Gallery to add scenic locations to your trip.</p>
                        </div>
                    </div>
                </div>

                <div class="tour-section" data-aos="fade-up">
                    <div class="section-header">
                        <i class="fas fa-calendar-alt"></i>
                        <h2>Day-by-Day Itinerary</h2>
                    </div>
                    <div class="section-content" id="itinerary-section">
                        <div class="no-items">
                            <i class="fas fa-calendar-alt"></i>
                            <p>No itinerary generated yet. Complete your selections and visit the Trip Planner to create your personalized itinerary.</p>
                        </div>
                    </div>
                </div>

                <div class="tour-section" data-aos="fade-up">
                    <div class="section-header">
                        <i class="fas fa-map"></i>
                        <h2>Map</h2>
                    </div>
                    <div class="section-content">
                        <div class="map-container" id="map">
                            <div class="no-items">
                                <i class="fas fa-map"></i>
                                <p>Map will be displayed here with all your selected locations.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <button class="print-btn" id="print-btn">
                <i class="fas fa-print"></i> Print Itinerary
            </button>
        </div>
    </main>

    <footer>
        <div class="footer-content">
            <div class="footer-section">
                <h3><i class="fas fa-landmark"></i> Bruges Guide</h3>
                <p>Your complete guide to exploring Bruges</p>
            </div>
            <div class="footer-section">
                <h3><i class="fas fa-link"></i> Quick Links</h3>
                <ul>
                    <li><a href="index.html"><i class="fas fa-home"></i> Home</a></li>
                    <li><a href="places-to-visit.html"><i class="fas fa-map-marker-alt"></i> Places</a></li>
                    <li><a href="restaurants.html"><i class="fas fa-utensils"></i> Food</a></li>
                    <li><a href="tours.html"><i class="fas fa-ship"></i> Tours</a></li>
                    <li><a href="gallery.html"><i class="fas fa-images"></i> Gallery</a></li>
                    <li><a href="planner.html"><i class="fas fa-calendar-alt"></i> Plan</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h3><i class="fas fa-envelope"></i> Contact</h3>
                <p>Email: info@brugesguide.com</p>
                <p>Phone: +32 123 456 789</p>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2024 Bruges Guide. All rights reserved.</p>
        </div>
    </footer>

    <script src="js/navigation.js"></script>
    <script src="js/selection-manager.js"></script>
    <script src="js/services/GroqService.js"></script>
    <script src="js/agents/BaseAgent.js"></script>
    <script src="js/agents/PlaceAgent.js"></script>
    <script src="js/agents/RestaurantAgent.js"></script>
    <script src="js/agents/TourAgent.js"></script>
    <script src="js/agents/PhotoAgent.js"></script>
    <script src="js/agents/ItineraryAgent.js"></script>
    <script src="js/agents/AgentManager.js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialize AOS
        AOS.init({
            duration: 800,
            easing: 'ease-in-out',
            once: true
        });

        // Initialize map
        let map;
        function initializeMap() {
            if (!map) {
                const mapContainer = document.getElementById('map');
                if (!mapContainer) return null;
                
                map = L.map('map').setView([51.2093, 3.2247], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(map);
            }
            return map;
        }

        document.addEventListener('DOMContentLoaded', async function() {
            // Show loading state
            const sections = ['places-section', 'restaurants-section', 'tours-section', 'photos-section', 'itinerary-section'];
            sections.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.innerHTML = `
                        <div class="no-items">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>Loading...</p>
                        </div>
                    `;
                }
            });

            try {
                console.log('Initializing selection manager...');
                window.selectionManager = new SelectionManager();
                
                console.log('Initializing agent manager...');
                window.agentManager = new AgentManager();
                
                console.log('Initializing agents...');
                await window.agentManager.initializeAgents();
                
                // Get agents after initialization
                const placeAgent = window.agentManager.getAgent('place');
                const restaurantAgent = window.agentManager.getAgent('restaurant');
                const tourAgent = window.agentManager.getAgent('tour');
                const itineraryAgent = window.agentManager.getAgent('itinerary');

                console.log('Agents initialized:', {
                    place: !!placeAgent,
                    restaurant: !!restaurantAgent,
                    tour: !!tourAgent,
                    itinerary: !!itineraryAgent
                });

                if (!placeAgent || !restaurantAgent || !tourAgent || !itineraryAgent) {
                    throw new Error('Some agents failed to initialize');
                }

                // Store agents in window for access
                window.agents = {
                    place: placeAgent,
                    restaurant: restaurantAgent,
                    tour: tourAgent,
                    itinerary: itineraryAgent
                };
                
                // Get selections
                const selections = window.selectionManager.getSelections();
                console.log('Current selections:', selections);
                
                // Display selections
                await displaySelections();

                // Initialize map
                initializeMap();
            } catch (error) {
                console.error('Failed to initialize:', error);
                // Show error message to user
                sections.forEach(sectionId => {
                    const section = document.getElementById(sectionId);
                    if (section) {
                        section.innerHTML = `
                            <div class="no-items">
                                <i class="fas fa-exclamation-triangle"></i>
                                <p>Error initializing: ${error.message}</p>
                            </div>
                        `;
                    }
                });
            }

            // Print button functionality
            document.getElementById('print-btn').addEventListener('click', async function() {
                try {
                    // Get the current selections
                    const selections = window.selectionManager.getSelections();
                    
                    // Get the itinerary agent
                    const itineraryAgent = window.agents.itinerary;
                    if (!itineraryAgent) {
                        throw new Error('Itinerary agent not available');
                    }

                    // Generate itinerary
                    const itinerary = await itineraryAgent.getRecommendations([
                        ...selections.places.map(id => ({ id, type: 'place' })),
                        ...selections.restaurants.map(id => ({ id, type: 'restaurant' })),
                        ...selections.tours.map(id => ({ id, type: 'tour' })),
                        ...selections.photos.map(id => ({ id, type: 'photo' }))
                    ]);

                    // Save to localStorage
                    localStorage.setItem('savedItinerary', JSON.stringify(itinerary));
                    
                    // Show success message
                    alert('Itinerary saved successfully!');
                    
                    // Print the page
                    window.print();
                } catch (error) {
                    console.error('Error saving itinerary:', error);
                    alert('Error saving itinerary. Please try again.');
                }
            });
        });

        async function getItemData(id, type) {
            try {
                console.log(`Getting data for ${type} with id: ${id}`);
                // Get the appropriate agent
                const agent = window.agents[type];
                if (!agent) {
                    throw new Error(`No agent found for type: ${type}`);
                }

                // Get the item details from the agent
                const itemDetails = await agent.getRecommendations([id]);
                console.log(`Item details for ${type} ${id}:`, itemDetails);
                
                if (!itemDetails || itemDetails.length === 0) {
                    throw new Error(`No details found for ${type} with id: ${id}`);
                }

                const item = itemDetails[0];
                const location = item.location || { lat: 51.2093, lng: 3.2247 };
                
                return {
                    name: item.name || `Unknown ${type}`,
                    description: item.description || `A ${type} in Bruges`,
                    image: item.image || getDefaultImage(type),
                    directions: `https://www.google.com/maps/dir/?api=1&destination=${location.lat},${location.lng}`,
                    coordinates: [location.lat, location.lng],
                    website: item.website || null,
                    hours: item.openingHours || item.hours || null,
                    price: item.price || item.admissionFee || null
                };
            } catch (error) {
                console.error(`Error getting ${type} data:`, error);
                return {
                    name: `${type} ${id}`,
                    description: `A ${type} in Bruges`,
                    image: getDefaultImage(type),
                    directions: `https://www.google.com/maps/dir/?api=1&destination=51.2093,3.2247`,
                    coordinates: [51.2093, 3.2247]
                };
            }
        }

        function getDefaultImage(type) {
            const defaultImages = {
                place: 'https://images.unsplash.com/photo-1555396273-367ea4eb4db5?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80',
                restaurant: 'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80',
                tour: 'https://images.unsplash.com/photo-1544551763-46a013bb70d5?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80',
                photo: 'https://images.unsplash.com/photo-1511735111819-9a3f7709049c?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80'
            };
            return defaultImages[type] || defaultImages.place;
        }

        async function displaySelections() {
            const selections = window.selectionManager.getSelections();
            console.log('Displaying selections:', selections);
            
            // Update counts
            document.getElementById('places-count').textContent = selections.places.length;
            document.getElementById('restaurants-count').textContent = selections.restaurants.length;
            document.getElementById('tours-count').textContent = selections.tours.length;
            document.getElementById('photos-count').textContent = selections.photos.length;

            // Display places
            await displaySection('places-section', selections.places, 'place');
            
            // Display restaurants
            await displaySection('restaurants-section', selections.restaurants, 'restaurant');
            
            // Display tours
            await displaySection('tours-section', selections.tours, 'tour');
            
            // Display photos
            await displaySection('photos-section', selections.photos, 'photo');

            // Update map
            await updateMap(selections);

            // Generate and display itinerary if there are selections
            if (selections.places.length > 0 || selections.restaurants.length > 0 || 
                selections.tours.length > 0 || selections.photos.length > 0) {
                await generateItinerary(selections);
            }
        }

        async function displaySection(sectionId, items, type) {
            console.log(`Displaying section ${sectionId} with ${items.length} items`);
            const section = document.getElementById(sectionId);
            
            if (items.length === 0) {
                section.innerHTML = `
                    <div class="no-items">
                        <i class="fas fa-${type === 'place' ? 'map-marked-alt' : 
                                        type === 'restaurant' ? 'utensils' : 
                                        type === 'tour' ? 'ship' : 'camera'}"></i>
                        <p>No ${type}s selected yet. Visit the ${type.charAt(0).toUpperCase() + type.slice(1)} page to add items to your trip.</p>
                    </div>
                `;
                return;
            }

            let html = '';
            
            for (const item of items) {
                console.log(`Processing ${type} item:`, item);
                // Handle both string IDs and object items
                const itemId = typeof item === 'string' ? item : item.id;
                if (!itemId) {
                    console.error('Invalid item format:', item);
                    continue;
                }
                
                const itemData = await getItemData(itemId, type);
                console.log(`Item data for ${type} ${itemId}:`, itemData);
                
                html += `
                    <div class="item-card">
                        <img src="${itemData.image}" alt="${itemData.name}" class="item-image">
                        <div class="item-details">
                            <h3>${itemData.name}</h3>
                            <p>${itemData.description}</p>
                            ${itemData.hours ? `<p><i class="fas fa-clock"></i> ${itemData.hours}</p>` : ''}
                            ${itemData.price ? `<p><i class="fas fa-euro-sign"></i> ${itemData.price}</p>` : ''}
                            <div class="item-actions">
                                <a href="${itemData.directions}" target="_blank" class="action-btn">
                                    <i class="fas fa-directions"></i> Directions
                                </a>
                                ${itemData.website ? `
                                    <a href="${itemData.website}" target="_blank" class="action-btn secondary">
                                        <i class="fas fa-globe"></i> Website
                                    </a>
                                ` : ''}
                                <button class="action-btn secondary remove-btn" data-id="${itemId}" data-type="${type}">
                                    <i class="fas fa-times"></i> Remove
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            section.innerHTML = html;

            // Add event listeners to remove buttons
            section.querySelectorAll('.remove-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const id = this.dataset.id;
                    const type = this.dataset.type;
                    selectionManager.removeSelection(id, type);
                    displaySelections();
                });
            });
        }

        async function updateMap(selections) {
            const currentMap = initializeMap();
            if (!currentMap) return;

            // Clear existing markers
            currentMap.eachLayer((layer) => {
                if (layer instanceof L.Marker) {
                    currentMap.removeLayer(layer);
                }
            });

            // Add markers for all selected items
            const allItems = [
                ...selections.places.map(id => ({ id, type: 'place' })),
                ...selections.restaurants.map(id => ({ id, type: 'restaurant' })),
                ...selections.tours.map(id => ({ id, type: 'tour' })),
                ...selections.photos.map(id => ({ id, type: 'photo' }))
            ];

            for (const item of allItems) {
                try {
                    const itemData = await getItemData(item.id, item.type);
                    if (itemData.coordinates) {
                        const marker = L.marker(itemData.coordinates).addTo(currentMap);
                        marker.bindPopup(`
                            <strong>${itemData.name}</strong><br>
                            ${itemData.description}<br>
                            <a href="${itemData.directions}" target="_blank">Get Directions</a>
                        `);
                    }
                } catch (error) {
                    console.error(`Error adding marker for ${item.type} ${item.id}:`, error);
                }
            }

            // Fit map bounds to show all markers
            if (allItems.length > 0) {
                const bounds = L.latLngBounds(allItems.map(item => {
                    return [51.2093, 3.2247]; // Default Bruges coordinates
                }));
                currentMap.fitBounds(bounds, { padding: [50, 50] });
            }
        }

        async function generateItinerary(selections) {
            const itinerarySection = document.getElementById('itinerary-section');
            
            try {
                // Get the itinerary agent
                const itineraryAgent = window.agents.itinerary;
                if (!itineraryAgent) {
                    throw new Error('Itinerary agent not available');
                }

                // Generate itinerary using the agent
                const itinerary = await itineraryAgent.getRecommendations([
                    ...selections.places.map(id => ({ id, type: 'place' })),
                    ...selections.restaurants.map(id => ({ id, type: 'restaurant' })),
                    ...selections.tours.map(id => ({ id, type: 'tour' })),
                    ...selections.photos.map(id => ({ id, type: 'photo' }))
                ]);

                // Display itinerary
                let html = '';
                
                itinerary.forEach(day => {
                    html += `
                        <div class="day-itinerary">
                            <div class="day-header">${day.title}</div>
                            <div class="timeline">
                    `;
                    
                    day.items.forEach(item => {
                        html += `
                            <div class="timeline-item">
                                <div class="timeline-time">${item.time}</div>
                                <div class="timeline-content">
                                    <h3>${item.name}</h3>
                                    <p>${item.description}</p>
                                    <a href="${item.directions}" target="_blank" class="action-btn">
                                        <i class="fas fa-directions"></i> Directions
                                    </a>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                });
                
                itinerarySection.innerHTML = html;
                
            } catch (error) {
                console.error('Error generating itinerary:', error);
                itinerarySection.innerHTML = `
                    <div class="no-items">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Error generating itinerary. Please try again later.</p>
                    </div>
                `;
            }
        }
    </script>
</body>
</html> 